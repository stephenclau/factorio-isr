# name: 01.Build Push To Docker For Latest
# on:
#   workflow_dispatch:  
#   push:
#     paths:
#       - 'Dockerfile'
#       - 'src/*.py'
#       - 'tests/*.py'
   

# jobs:
#   latest-dev-build:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       security-events: write
    
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_TOKEN }}
      
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Validate build configuration
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           call: check

#       - name: Build and push
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           push: true
#           tags: ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKERHUB_REPO }}:latest



name: 01.Build Push To Docker For Latest

on:
  workflow_dispatch:
  push:
    paths:
      - 'Dockerfile'
      - 'src/*.py'
      - 'tests/*.py'

jobs:
  latest-dev-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1    
      - 
        name: Validate build configuration
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # v6.18.0
        with:
          context: .
          call: check

      - name: Delete previous :latest image and cleanup orphaned images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete :latest tag from Docker Hub
          curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.DOCKER_TOKEN }}" \
            "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKERHUB_REPO }}/tags/latest/" || true
          
          # Delete :latest tag and cleanup untagged images from GHCR
          gh api --method DELETE /user/packages/container/${{ github.event.repository.name }}/versions \
            -f package_version_ids=$(gh api /user/packages/container/${{ github.event.repository.name }}/versions \
            --jq '.[] | select(.tags | length == 0) | .id' | jq -s .) || true
        continue-on-error: true

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKERHUB_REPO }}:latest