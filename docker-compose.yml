services:
  factorio-isr:
    # Accept UID/GID as build args, default to 1001
    build:
      context: .
      dockerfile: Dockerfile
    container_name: factorio-isr
    restart: unless-stopped
    user: "1001:1001" # Set to match UID:GID of host non root user i.e. factorio (or different if standalone)
    volumes: 
      - /home/factorio/log:/logs:ro
      - /home/factorio/script-output:/mod-logs:ro
    secrets:
      - DISCORD_WEBHOOK_URL
    environment:
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - FACTORIO_LOG_PATH=/logs/console.log
      - HEALTH_CHECK_HOST=0.0.0.0
      - HEALTH_CHECK_PORT=8080
      - BOT_NAME=Factorio Bridge
    ports:
      - "8080:8080"
    networks:
      - factorio-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  factorio-net:
    external: true
    name: factorio_factorio-net

secrets:
  DISCORD_WEBHOOK_URL:
    file: ./.secrets/DISCORD_WEBHOOK_URL.txt

